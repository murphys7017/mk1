# mk1（Alice）智能体系统项目总结

## 项目定位

mk1 是一个具备“感知 → 记忆 → 推理 →（行动，规划中）→ 记忆更新”认知闭环的智能体原型。
当前以 Alice 为顶层智能体角色，支持多轮对话、对话摘要、对话状态更新，并在向“可插拔 LLM / 可插拔上下文组装 / 事件驱动”方向重构。

## 当前主流程（main/Alice）

1. CLI 接收用户输入（`main.py`）
2. `Alice.respond()` 调用 `PerceptionSystem.analyze()` 并发分析输入（Ollama 文本分析 + LTP 结构化分析）
3. 生成 `ChatMessage`（text 为主，已预留 voice/image/video 字段，并可附带 `AnalyzeResult`）
4. 将 user 消息写入 SQLite 历史记录（包含可选的 `AnalyzeResult` 持久化）
5. `DefaultGlobalContextAssembler.build_messages()` 组装 system prompt（Memory + ChatState + ResponseProtocol）+ recent history
6. 调用 Agent client 生成回复（当前默认走本地 Ollama chat）
7. 将 assistant 回复写入 SQLite 历史记录
8. 发布 `assistant_response_generated` 事件，触发回合后处理（摘要/状态更新等）

## 模块分层与职责

- 入口与顶层：`main.py`、`Alice.py`
- 感知系统：`PerceptionSystem/`（当前仅 `TextAnalyze`）
- 记忆系统：`MemorySystem/`（策略、存储、组装、摘要）
- 对话状态：`ChatStateSystem/`（状态判定与输出）
- 上下文组装：`ContextAssembler/`（拼接记忆、状态、历史）
- LLM 管理：`LLM/`（Prompt 模板 + 模型路由）
- 历史持久化：`RawChatHistory/`（SQLite / 文件版备用）
- 数据模型：`DataClass/`（ChatMessage、DialogueMessage、ChatState 等）
- 事件驱动：`EventBus.py` / `PostTurnProcessor.py`（骨架）
- 代理客户端：`Agent/QwenClient.py`

## 当前集成状态（要点）

- ✅ `DefaultGlobalContextAssembler` 已接入 `Alice.respond()`，主链路可用（system prompt + recent history）
- ✅ `EventBus` 已实现队列分发，`PostTurnProcessor` 已订阅 assistant 回复事件并触发摘要/状态更新
- ✅ `RawChatHistory` 已统一走 SQLite（并支持 `AnalyzeResult` 1:1 关联持久化）
- ⚠️ `AnalyzeResult` 目前仍主要保存在 message/DB 中，尚未进入 prompt（“分析结果体现在 prompt 中”未完成）
- ⚠️ `LLMManagement.model_map` 的 `generate_response -> qwen-plus` 与 `llm_map` 未对齐（当前主回复走 Agent client，暂不影响主链路，但后续需要统一）
- ⚠️ `DataClass/` 与 `MessageModel.py` 同时存在，仍处于过渡期

## 技术栈与依赖

- Python >= 3.10
- 依赖：loguru、sqlalchemy、openai、python-dotenv
- 本地推理：Ollama（`qwen3:1.7b`、`qwen3:4b`）
- 云端推理：DashScope 兼容 OpenAI API（`qwen-plus`）
- 存储：SQLite（`chat_history.db`）

## 运行方式（简要）

```bash
uv sync
uv run .\main.py
```

## 近期计划（摘自 docs/TODO.md）

- 输入与输出解耦，支持多次输入后再由 AI 输出
- 设计并接入管线化或事件化处理流程
- 增加 TTS / STT，实现语音交互
- 设计长期记忆模块，使 AI 稳定记住用户基础信息

## 补充计划

- 将 `AnalyzeResult` 以“摘要/信号”的形式注入 system prompt（避免把 raw 全量塞进 prompt）
- 统一 `LLMManagement` 的模型命名与实现映射，明确“结构化输出（JSON）”与“自然语言回复”两条路径

## 参考文档

- `README.md`
- `docs/gpt-整体流程.md`
- `docs/集成收尾问题清单.md`
- `docs/TODO.md`
