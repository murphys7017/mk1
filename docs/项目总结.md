# Alice AI 聊天机器人项目总结

## 📋 项目概述

这是一个名为 **Alice（爱丽丝）** 的渐进式学习AI聊天机器人项目，核心特点是具有**持续记忆能力**和**感知分析系统**，能够积累经历、形成个性并随时间演进。

---

## 🏗️ 核心架构

### 主处理流程（Pipeline）

```
用户多模态输入 
  ↓
感知系统分析（PerceptionSystem）
  ↓
记忆系统构建上下文消息（MemorySystem）
  ↓
LLM生成响应（QwenClient）
  ↓
返回响应给用户
  ↓
更新记忆系统（原始历史 + 对话状态）
```

---

## 📦 模块详解

### 1️⃣ 入口与主控制器

#### main.py
- 程序入口
- 初始化 QwenClient 和 Alice 实例
- 提供交互式命令行界面

#### Alice.py
- 核心控制类
- 协调各子系统工作
- 关键方法：
  - process_input(): 处理多模态输入，调用感知系统分析
  - respond(): 生成响应，更新记忆
  - aggregated_input(): 聚合多个用户输入

---

### 2️⃣ 数据模型层

#### MessageModel.py
定义三个核心数据类：

- **ChatMessage**: 单条对话消息
  - 字段：role, content, timestamp, media_type, extra, chat_turn_id
  - 支持文本/图像/音频/视频等多媒体类型
  
- **DialogueMessage**: 对话摘要
  - 字段：dialogue_id, start_turn_id, end_turn_id, summary, is_completed
  - 用于存储已压缩的对话阶段摘要
  
- **ChatState**: 对话状态
  - 字段：interaction, user_attitude, emotional_state, leading_approach
  - 记录当前对话的交互模式、情绪等

---

### 3️⃣ 原始对话历史管理（RawChatHistory）

#### RawChatHistory.py
- 统一接口层，封装数据存储操作

#### SqlitManagementSystem.py
- SQLite 数据库管理（当前使用）
- 使用 SQLAlchemy ORM
- 两张表：
  - chat_messages: 存储原始对话
  - dialogue_messages: 存储对话摘要
- 提供增删改查接口

#### RawChatHistoryFile.py
- 基于文件的历史管理（备用方案）
- 使用 JSON Lines 格式
- 支持增量加载和高效倒序读取

---

### 4️⃣ 感知系统（PerceptionSystem）

#### PerceptionSystem.py
- 多模态输入分析入口
- 当前支持文本分析

#### TextAnalyze.py
使用本地小模型（qwen3:1.7b）对文本进行客观观察：
- 是否包含问题？
- 是否提及AI自身？
- 提到了哪些实体/主题词？
- 包含哪些情绪词汇？

分析结果存入 ChatMessage.extra 字段。

---

### 5️⃣ 记忆系统（MemorySystem）- 核心创新

#### 整体架构
```
MemorySystem (协调器)
├── MemoryPolicy (策略引擎)
├── MemoryStorage (存储管理)
│   ├── IdentitiyMemory (身份记忆)
│   ├── DialogueStorage (对话摘要管理)
│   └── ChatStateStorage (对话状态管理)
└── MemoryAssembler (消息组装器)
```

#### MemorySystem.py
- 顶层协调器
- 调用 buildMessages() 为 LLM 构建完整上下文

#### MemoryPolicy.py
策略决策引擎，使用小模型判断：
- splitBufferByTopic(): 判断对话是否延续已有话题
- judgeDialogueSummary(): 判断是否需要生成摘要

#### MemoryStorage.py
统一存储接口，聚合三类记忆：
- 身份记忆（Identity）
- 对话摘要（Dialogue）
- 对话状态（ChatState）

#### IdentitiyMemory.py
- 加载 Alice_personality.txt
- 提供核心身份设定（CoreIdentity）
- 强调持续存在、积累经历的特性

#### DialogueStorage.py
最复杂的模块，实现渐进式对话压缩：

关键机制：
1. 维护 raw_buffer（未摘要对话）
2. 当对话达到阈值（min_raw_for_summary=4轮）时：
   - 调用 MemoryPolicy 判断是否需要摘要
   - 使用小模型判断话题延续性
   - 决定是更新现有摘要 or 创建新摘要
3. 使用 qwen3:4b 生成事实性、第三人称摘要
4. 将摘要存入数据库，清空对应的 raw_buffer

摘要策略：
- 只记录已发生的事实
- 不保留语气、角色扮演细节
- 不推断未来行为
- 区分"合并到现有摘要"和"创建新摘要"

#### ChatStateStorage.py
- 每隔一定轮次（history_window=4）更新对话状态
- 使用 qwen3:1.7b 分析最近对话
- 判断交互类型、用户态度、情绪状态、主导方式

#### MemoryAssembler.py
消息组装器，构建发送给 LLM 的完整上下文：

System Prompt 结构：
```xml
<IDENTITY_CORE> 核心身份 + 人格 </IDENTITY_CORE>
<WORLD_SETTING> 世界设定（预留） </WORLD_SETTING>
<MEMORY_LONG> 长期记忆（预留） </MEMORY_LONG>
<KNOWLEDGE> 知识库（预留） </KNOWLEDGE>
<MEMORY_MID> 中期记忆（已摘要的对话） </MEMORY_MID>
<CHAT_STATE> 当前对话状态 </CHAT_STATE>
<RESPONSE_PROTOCOL> 回答规范 </RESPONSE_PROTOCOL>
```

然后附加最近 N 轮原始对话（history_window=20）。

---

### 6️⃣ LLM 交互层

#### Agent/QwenClient.py
- 封装通义千问 API 调用
- 使用 qwen-plus 模型
- 设置 temperature=1.2, top_p=0.7

#### LocalModelFunc.py
- 本地小模型调用封装
- 支持 Ollama API（主要使用）
- 支持 OpenAI API（备用）
- 处理 JSON 输出提取与解析

---

### 7️⃣ 配置与工具

#### SystemPrompt.py
集中管理所有提示词模板：
- 文本分析提示词
- 摘要判断提示词
- 对话摘要生成提示词
- 话题延续判断提示词
- 对话状态判断提示词

#### tools.py
- normalizeBlock(): 压缩空白字符，统一格式

---

## 🔄 完整工作流程示例

1. 用户输入："今天天气真好"
   
2. 感知分析（TextAnalyze）
   - 调用 qwen3:1.7b
   - 结果：{"is_question": false, "mentioned_entities": ["天气"], "emotional_cues": ["好"]}

3. 添加到历史
   - 存入 SQLite chat_messages 表
   - 分配 chat_turn_id

4. 检查对话状态
   - 每 4 轮更新一次 ChatState

5. 记忆系统处理
   - 检查 raw_buffer 长度
   - 如果 ≥4 轮且策略判断需要摘要：
     - 判断话题延续性
     - 生成或更新摘要
     - 清空已摘要部分
   
6. 消息组装
   - 加载身份记忆
   - 加载最近 3 条摘要
   - 加载当前对话状态
   - 附加最近 20 轮原始对话
   
7. LLM 生成
   - 调用 QwenClient
   - 返回响应："是啊，阳光明媚的日子总让人心情愉快～"

8. 更新历史
   - 将 AI 响应存入数据库

---

## 🎯 核心设计亮点

### 分层记忆架构
- 短期：raw_buffer（未摘要对话）
- 中期：DialogueMessage（已摘要对话）
- 长期：预留扩展（MEMORY_LONG）

### 渐进式压缩
- 不是简单的滑动窗口
- 智能判断话题延续性
- 动态决定合并 or 新建摘要

### 小模型辅助决策
- 使用 qwen3:1.7b/4b 进行策略判断
- 降低主 LLM 负担
- 提高决策可控性

### 事实性摘要
- 明确规则：只记录已发生事实
- 避免情绪化、角色扮演风格污染
- 第三人称客观表述

### 模块化设计
- 各系统职责清晰
- 存储层可切换（SQLite/File）
- 易于扩展新功能

---

## 📊 技术栈

- 语言：Python
- 主 LLM：通义千问 qwen-plus
- 辅助模型：Ollama qwen3:1.7b/4b
- 数据库：SQLite + SQLAlchemy
- 日志：loguru
- 依赖管理：uv

---

## 🔧 可改进方向

1. 长期记忆层：实现向量数据库存储
2. 知识库：集成外部知识源
3. 多模态：完善图像/音频感知
4. 情感建模：更细粒度的情绪跟踪
5. 对话策略：更主动的话题引导
6. 摘要质量：引入评估与反馈机制

---

这是一个设计精良的具有记忆演进能力的 AI 聊天机器人框架，核心创新在于分层记忆管理和智能对话压缩机制。
