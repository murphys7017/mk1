# mk1 当前代码需要收尾的集成问题清单

本文档聚焦“能跑通主链路 + 各模块真实接线”的工程收尾问题，按优先级从高到低排列。

## P0（会直接导致主流程不可用 / 产出为空）

1. **输入协议不一致（main → Alice → PerceptionSystem）**
   - ✅ 已修复：当前 [main.py](../main.py) 已统一为 `{"text": user_input}`，与 `PerceptionSystem` 的 analyzer 映射一致。

2. **`Alice.respond()` 尚未把上下文组装器接入**
   - ✅ 已修复：[src/Alice.py](../src/Alice.py) 已在初始化时创建 `DefaultGlobalContextAssembler`，并在 `respond()` 中使用 `messages = self.assembler.build_messages(user_input)`。

3. **`ContextAssembler/DefaultGlobalContextAssembler` 依赖的方法当前不存在**
    - ✅ 已部分修复：
       - [src/ChatStateSystem/ChatStateSystem.py](../src/ChatStateSystem/ChatStateSystem.py) 已定义 `assemble()` 抽象接口，并提供 [src/ChatStateSystem/DefaultChatStateSystem.py](../src/ChatStateSystem/DefaultChatStateSystem.py) 默认实现。
       - `DefaultGlobalContextAssembler` 已改为依赖 `MemorySystem.assemble()` + `ChatStateSystem.assemble()`。
    - ✅ 已确认：当前 `Alice` 已实例化 `DefaultChatStateSystem` 并注入 assembler。

## P1（逻辑已写但会静默失效 / 质量显著下降）

1. **摘要生成 prompt 的字段命名仍不一致（summarize_dialogue）**
   - 现状：[src/SystemPrompt.py](../src/SystemPrompt.py) 中 `summarize_dialogue` 模板使用 `{summary_text}` / `{dialogues_text}`。
   - ✅ 已修复：`DialogueStorage.summarize_dialogue()` 已改为向 `LLMManagement.generate()` 传递 `summary_text` 和 `dialogues_text`（与 `SystemPrompt` 的 `required_fields` 对齐），摘要生成调用现在可正常命中模板。
   - 建议：后续新增 prompt 时仍需保持 `PromptTemplate.required_fields` 与调用处传参名一致，避免类似问题复现。

2. **结构化生成（JSON）与对话回复（自然语言）未分离**
   - ✅ 已修复：
     - [src/LLM/OllamaFormated.py](../src/LLM/OllamaFormated.py) 用于结构化 JSON 输出（裁判/摘要/分析）。
     - [src/LLM/OllamaChat.py](../src/LLM/OllamaChat.py) 用于自然语言对话回复。
     - [src/LLM/LLMManagement.py](../src/LLM/LLMManagement.py) 提供 `generate()`/`chat()` 两条入口。

3. **导入路径/包结构一致性（src layout）**
   - 现状：代码已迁移到 `src/`，并使用 setuptools 的 `where = ["src"]` 进行包发现。
   - 风险：若出现绝对 import 与包名不一致，可能在“直接运行脚本 vs 安装为包”场景下表现不同。
   - 建议：保持 `src/` 下包结构与 import 风格一致；必要时为目录补齐 `__init__.py`，并优先通过 `uv run` 运行。

## P2（安全性/可维护性问题，建议尽早处理）

1. **API Key 明文硬编码在代码中**
   - ✅ 已修复：
       - [main.py](../main.py) 已改为从环境变量读取 `OPENAI_API_KEY`。
       - `.env` 已加入 `.gitignore`，适合本地开发。
   - 建议：在 README 补充 `.env` 示例与字段说明（例如 `OPENAI_API_KEY=...`）。
2. **EventBus/PostTurnProcessor 仍是骨架，未形成真实“事件管线”**
    - ✅ 已修复：
       - [src/EventBus.py](../src/EventBus.py) 已实现异步队列分发（无事件循环时回退同步派发）。
       - [src/PostTurnProcessor.py](../src/PostTurnProcessor.py) 已订阅 `assistant_response_generated`，并触发摘要/状态更新。
    - 仍建议补齐：
       - 增加 `user_input_received` 事件（用于把“分析/写库/状态更新”更明确地拆成管线阶段）。
       - 明确回合后任务的错误隔离与重试策略（避免一个 handler 抛错拖垮整条链路）。

3. **AnalyzeResult 注入 prompt 的可控性与长度控制**
   - ✅ 已接入：当前 [src/ContextAssembler/DefaultGlobalContextAssembler.py](../src/ContextAssembler/DefaultGlobalContextAssembler.py) 会将近期多轮 `AnalyzeResult` 转成 prompt 片段注入 `<ANALYZE>`。
   - 仍建议：
     - 控制注入窗口（例如只保留最近 N 轮/只保留 keywords + entities + is_question 等）。
     - 避免把 raw 全量注入 prompt（成本高且不稳定）。

## 建议的收敛顺序（最小可跑通主链路）

1. ✅ 输入协议已统一（main → Alice → PerceptionSystem）
2. ✅ 在 `Alice.respond()` 中接入 `DefaultGlobalContextAssembler.build_messages()`
3. ✅ 确认 `DefaultChatStateSystem` 实例化与注入（确保 `assemble()` 真正可用）
4. ✅ 修复 `summarize_dialogue` 的字段命名不匹配
5. ✅ 已修复：`python-dotenv` 依赖已补齐（或移除 dotenv）。
6. 统一 LLMManagement 的 `model_map/llm_map` 以及 Qwen 输出格式策略

（更新：当前已迁移到 `src/`，并且 `LLMManagement` 已完成“结构化生成 vs 对话回复”的分离；后续重点更偏向多模态与长期记忆接线。）
