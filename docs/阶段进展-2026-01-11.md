# 阶段进展（截至 2026-01-11）

本文档用于把近期代码变更与 docs/TODO.md、docs/项目总结.md 的目标对齐，便于快速回答：做了什么、完成了什么、现在项目跑到哪一步。

## 总览

- 主链路已跑通：输入 → 感知（并发）→ 写入历史（SQLite）→ 组装上下文 → 本地模型生成回复 → 写入历史 → 发布事件 → 回合后处理。
- 感知层新增结构化容器 `AnalyzeResult`，并支持写入 SQLite（1:1 关联到消息）。
- 事件驱动骨架不再是空壳：`EventBus` + `PostTurnProcessor` 已能把“回合完成后处理”挂上去（摘要/状态更新）。

## 近期完成/进展（按能力块）

### 1) 感知（Perception）

- 并发分析：文本输入会同时走 Ollama 文本分析与 LTP 分析，结果合并为单个 `AnalyzeResult`。
- 多模态预留：`ChatMessage` 已包含 voice/image/video 字段；输入协议也允许携带这些字段，但暂未提供对应分析器。

### 2) 历史与存储（RawChatHistory + SQLite）

- `RawChatHistory` 统一通过 SQLite 管理历史。
- 数据层支持 `ChatMessage` 1:1 关联 `AnalyzeResult`（以及 entities/frames/relations 子表），并支持级联删除。

### 3) 上下文组装（ContextAssembler）

- `DefaultGlobalContextAssembler` 已接入主链路：把 Memory + ChatState + ResponseProtocol 拼成 system prompt，再追加 recent history。

### 4) 记忆与摘要（MemorySystem）

- `DialogueStorage` 已实现摘要决策（judge）+ 分段（split）+ 生成/更新摘要（summarize）并落库。
- 摘要触发时机：当前通过 `assistant_response_generated` 的回合事件触发。

### 5) 对话状态（ChatStateSystem）

- `DefaultChatStateSystem` 已实现定期更新（按窗口阈值触发）并可注入 prompt。

### 6) 事件驱动（EventBus + PostTurnProcessor）

- `EventBus` 已实现队列分发与 sync fallback。
- `PostTurnProcessor` 已订阅 assistant 回复事件，并调度“摘要/状态更新”。

## 与 TODO 的对照结论

- 已完成：LTP 接入与并发分析、AnalysisResult/多模态字段预留、SQLite 分层存储与持久化、主链路接线（assembler/event）。
- 部分完成：多模态（只完成字段与协议预留，缺少 image/audio/video 分析器与端到端用法）。
- 未完成：分析结果进入 prompt（目前主要落库/挂在 message 上）；输入/输出解耦；TTS/STT；真正的长期记忆模块。

## 当前风险与“下一步最值得做”的事

1. `LLMManagement` 的 `model_map` 与 `llm_map` 命名未统一（例如 `generate_response -> qwen-plus`），容易出现静默失效。
2. `QwenFormated` 强制 JSON 输出，适合结构化决策但不适合自然语言回复生成，建议拆分两条调用链。
3. `MessageModel.py` 与 `DataClass/` 并存，建议尽快收敛到单一数据模型来源。
4. AnalyzeResult 注入 prompt：建议先做“轻量信号摘要注入”，不要把 raw 全量塞进 prompt。
