# 阶段进展（截至 2026-01-19）

本文档记录从 2026-01-13 的阶段总结之后，到当前为止的结构性变化与主链路真实状态，并对齐 docs/TODO.md、docs/项目总结.md、docs/集成收尾问题清单.md。

## 本轮更新摘要

- 引入 QuerySystem：新增 QuerySchema 数据结构与构建链路（SignalDensity/Intent 等属性构建器），在主链路中生成并挂载到 ChatMessage。
- 引入 PostTreatmentSystem：回合后处理扩展为可插拔 handler 管线，并加入 Live2D 相关的动作/意图生成能力（Motion3Builder + motion 资源）。
- RawChatHistory 增强：为近期 history/dialogue 增加内存缓存，降低频繁读库开销。
- 对话摘要决策升级：摘要判定从“单一 split_index”扩展为 SummaryDecision（支持 merge/new 等动作），并把摘要更新改为尽量异步触发，降低阻塞主回合风险。
- Prompt 标准化/配置化推进：SystemPrompt 侧对若干 prompt 的结构化输出更标准化，并引入 config/system_prompt.yaml 作为“可外置固定内容”的入口（后续可继续推进为单一来源）。
- 工程化补齐：新增日志配置、WebSocket 传输（实验性），以及若干结构调整/优化。

## 当前主链路（简述）

1. main 输入 → Alice.respond()
2. PerceptionSystem.analyze() 生成 AnalyzeResult（OllamaAnalyze + LTP）
3. QuerySystem 构建 QuerySchema（SignalDensityJudge + IntentJudgeL 等），挂到 user ChatMessage
4. 写入 SQLite 历史（RawChatHistory）
5. DefaultGlobalContextAssembler.build_messages() 组装 system prompt（Memory + ChatState + Analyze + ResponseProtocol）+ recent history
6. LLMManagement.chat() 生成 assistant 回复
7. 写入 SQLite，并发布 assistant_response_generated 事件
8. PostTurnProcessor 响应事件：触发摘要更新/状态更新，并异步调度 PostHandleSystem.handle()

## 仍待处理/风险点（建议优先）

1. QuerySchema 尚未真正驱动检索/工具调用：当前更多是“生成并挂载”，retrieve/mode/top_k 等字段未形成闭环。
2. QuerySchema 的持久化策略未收敛：ChatMessage.to_json()/from_dict 未包含 query_schema（目前仅运行时可用）。
3. LLMManagement 的实现映射尚未完全收敛：后续若要支持“按 supportModel()/自动发现”或“按配置映射”需要选定单一路线并固化。
4. system_prompt.yaml 与代码 builder 的同步成本：需要明确“谁是 source of truth”，并解决模板花括号/字段替换的安全渲染问题。
5. PostTreatmentSystem 可靠性：handler 失败隔离、幂等、超时与 POST_HANDLE_COMPLETED 的消费逻辑仍需补齐。
