```markdown
# 阶段进展（截至 2026-02-03）

本文档基于代码扫描与现有 docs 的汇总，说明目前各模块功能实现状况、已完成/进行中/待办项，以及短期优先级建议。

## 一、总体状态

- 主链路已完整接通：CLI 输入 → `Alice.respond()` → `PerceptionSystem.analyze()`（并发 Ollama/LTP）→ 写入 `RawChatHistory`（SQLite）→ `DefaultGlobalContextAssembler` 组装 system prompt（Memory + ChatState + Analyze + ResponseProtocol）→ `LLMManagement.chat()` 或 `generate()` → 写库 → 发布事件并触发回合后处理。
- 可以在本地以命令行交互运行（见 README）。

## 二、各模块功能与实现状态（要点）

- 感知层（`src/PerceptionSystem/`）
  - 功能：并发调用 OllamaAnalyze 与 LTP，合并为 `AnalyzeResult`，供 prompt 注入与持久化。
  - 状态：已实现并接入主链路；多模态分析（image/audio/video）仅在数据模型层预留，未实现分析器。

- 历史与存储（`src/RawChatHistory/`）
  - 功能：SQLite 为主的历史缓存层，提供内存缓存 + DB 拉取，方法包括 `getHistory`、`getHistoryByRole`、`addMessage`、`getDialogues`、`addDialogues`、`updateDialogue` 等。
  - 状态：已实现，`RawChatHistory` 封装了 `SqlitManagementSystem` 并维护内存队列。

- 记忆系统（`src/MemorySystem/`）
  - 功能：对话摘要判定与管理（`DialogueStorage`）、记忆拼接（`MemoryAssembler`）与上层封装（`MemorySystem`）。
  - 状态：摘要流水线已实现：`DialogueStorage` 有决策函数（`should_consider_summarize`）、摘要触发（异步/线程/直接调用）与 `summarize_dialogue`（调用 `LLMManagement.generate(prompt_name="summarize_dialogue")`），并会通过 `RawChatHistory.addDialogues`/`updateDialogue` 写入结果；`MemoryAssembler` 目前把 `world_core`、`identity` 与短期 summary（最近 3 条）拼成 `PromptBuilder`，可直接注入 system prompt。

- 上下文组装（`src/ContextAssembler/DefaultGlobalContextAssembler.py`）
  - 功能：将 memory、chat state、分析结果和响应协议组装成 `system` 内容，并将 recent raw history 作为 user/assistant turns 附加到 messages 列表末尾。
  - 状态：已实现，调用 `memory_system.assembleWorldCore()`、`assembleIdentity()`、`assembleShortMemory()`，并把若干条 `AnalyzeResult` 注入分析块。

- LLM 管理（`src/LLM/LLMManagement.py`）
  - 功能：统一入口，区分两类调用：`generate()`（结构化/JSON 输出）与 `chat()`（自然语言对话）。支持通过 `config/system_prompt.yaml` 映射 prompt->model，并在初始化时构建 `llm_map`（通过 `OllamaChat`、`OllamaFormated`、`QwenFormated` 的 `supportModel()`）。
  - 状态：已实现 `render_prompt()`（对模板占位与花括号安全处理）、`chat()`、`generate()`；`generate()` 会根据 `prompt_name` 从 `system_prompt` 取模板并调用对应 LLM 实现的 `generate()`。

- 回合后处理与事件（`src/EventBus.py`、`src/PostTurnProcessor.py`、`src/PostTreatmentSystem/`）
  - 功能：事件分发、回合结束后的摘要/状态更新、可插拔的 handler 管线（如 Live2D 输出）。
  - 状态：`EventBus` 与 `PostTurnProcessor` 已接入，`PostTreatmentSystem` 的 handler 管线已存在，但需要补齐失败隔离、幂等与超时策略。

- QuerySystem（`src/QuerySystem/`）
  - 功能：为 user 消息构建 `QuerySchema`（signal density、intent、检索策略等），用于后续检索或路由决策。
  - 状态：已生成并挂载到 `ChatMessage`，目前为运行时字段；尚未形成检索/工具调用的闭环，也未决定是否/如何持久化 `QuerySchema`。

- Prompt 构建与系统 Prompt（`src/tools/PromptBuilder.py`、`config/system_prompt.yaml`）
  - 功能：模块化构建 system prompt，支持 Tag 分区与 include/extend。
  - 状态：已实现 PromptBuilder；`system_prompt.yaml` 与代码 builder 的单一来源尚未收敛，需要明确 template 必填字段与安全替换策略。


## 三、已完成 / 进行中 / 未完成（高层）

- 已完成：主链路接通、`AnalyzeResult` 注入、SQLite 历史层、`LLMManagement` 双链路、`DialogueStorage` 摘要流程骨架、`MemoryAssembler` 短期摘要拼接、EventBus + PostTurnProcessor。
- 进行中：`QuerySystem` 的闭环（检索/工具调用）、`PostTreatmentSystem` 的可靠性（隔离/重试）、system_prompt 的单一来源收敛。
- 未完成 / 待实现：多模态分析器（image/audio/video）、`DialogueStorage` 的摘要策略调优与评估、QuerySchema 的持久化与回放、最终的 LLM 模型映射策略固化（按配置 vs 自动发现）。

## 四、短期建议（按优先级）

1. 固化 `LLMManagement` 的 `model_map` 映射策略并编写覆盖 `summarize_dialogue`、`judge_dialogue_summary` 的单元测试，确保摘要端到端可测。
2. 让 `QuerySystem` 驱动一次简单检索闭环（例如：基于 `query_schema.retrieve` 触发本地 SQLite / 简单关键词检索并注入上下文），以验证字段设计。 
3. 补齐 `PostTreatmentSystem` 的失败隔离和幂等策略（防止 handler 失败影响关键回合流）。
4. 增强 `MemoryAssembler`：增加配置化短期/中期记忆窗口与优先级规则，避免把过多无关摘要注入 prompt。

## 五、我已经做了什么

- 扫描并核对了关键代码文件：`src/LLM/LLMManagement.py`、`src/RawChatHistory/RawChatHistory.py`、`src/MemorySystem/MemoryStore/DialogueStorage.py`、`src/MemorySystem/MemoryAssembler.py`、`src/MemorySystem/MemorySystem.py`、`src/ContextAssembler/DefaultGlobalContextAssembler.py`。
- 基于代码实现更新了本文件的进展说明与短期建议。

- 已实现变更：`MemoryStorage` 新增了一组对 `RawChatHistory` 的包装方法（`add_message`/`get_history`/`get_history_by_role`/`delete_message_by_id`/`get_dialogues`/`get_dialogue_by_id`/`add_dialogue`/`update_dialogue`），用于把数据库的增删改查统一通过 Memory 层暴露，推荐上层调用 `MemoryStorage` 的接口而非直接访问 `RawChatHistory`。

## 六、下一步（我建议）

- 若你同意，我可以：
  1. 为 `summarize_dialogue` 路径写一个小型端到端单测（构造若干 `ChatMessage`、调用 `DialogueStorage.ingestDialogue()` 并断言 `RawChatHistory` 中新增/更新 dialogue）；
  2. 或先检查 `src/QuerySystem/` 的实现并尝试实现一次检索闭环的 PoC。

请选择你希望我先做的项（1 或 2），或告诉我有其它优先级。 

## 七、已替换 / 未替换文件（当前状态）

已替换（安全迁移）：
- `src/MemorySystem/MemoryStore/MemoryStorage.py`（新增消息历史 CRUD 接口并集中管理）。
- `src/MemorySystem/MemoryStore/DialogueStorage.py`（摘要逻辑集中，提供 dialogue CRUD）。

尚未替换（建议人工评估后再改动的高风险位置）：
- [src/Alice.py](src/Alice.py) — 初始化阶段直接持有 `RawChatHistory`，影响范围较广，建议在确保构造流程一致后替换为 `MemoryStorage` 注入。
- [src/ContextAssembler/DefaultGlobalContextAssembler.py](src/ContextAssembler/DefaultGlobalContextAssembler.py) — 组装 system prompt 时直接使用 `raw_history`，可改为通过 `MemorySystem` 的 `get_history`/`get_history_by_role` 读取。
- [src/PostTurnProcessor.py](src/PostTurnProcessor.py) 与 [src/PostTreatmentSystem/*](src/PostTreatmentSystem/) 下的 handler（`PostHandleSystem.py`、`OllamaHandler.py`、`LtpHandler.py` 等）— 这些组件在回合后路径中承担异步/副作用操作，直接替换需小心处理幂等与异常隔离。

说明：我已用代码搜索定位了仍引用 `RawChatHistory` 的文件（包括以上清单）。如果你希望，我可以：
- 逐文件生成替换补丁（先在本地运行测试），或
- 为上述高风险文件设计迁移步骤与回退策略，逐步替换并添加回归测试。

```